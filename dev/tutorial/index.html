<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · JuMag.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">JuMag.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">JuMag.jl</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#An-example-–-vortex-1"><span>An example – vortex</span></a></li><li><a class="tocitem" href="#How-to-enable-GPU-1"><span>How to enable GPU</span></a></li><li><a class="tocitem" href="#Standard-Problem-#4-1"><span>Standard Problem #4</span></a></li><li><a class="tocitem" href="#A-NEB-example-(vortex-core-reversal)-1"><span>A NEB example (vortex core reversal)</span></a></li><li><a class="tocitem" href="#Monte-Carlo-(M-T-curve)-1"><span>Monte Carlo (M-T curve)</span></a></li></ul></li><li><a class="tocitem" href="../equations/">Implemented equations</a></li><li><a class="tocitem" href="../notes/">Notes</a></li><li><a class="tocitem" href="../functions/">Function References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ww1g11/JuMagDocs.jl/blob/master/docs/src/tutorial.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial-1"><a class="docs-heading-anchor" href="#Tutorial-1">Tutorial</a><a class="docs-heading-anchor-permalink" href="#Tutorial-1" title="Permalink"></a></h1><h2 id="An-example-–-vortex-1"><a class="docs-heading-anchor" href="#An-example-–-vortex-1">An example – vortex</a><a class="docs-heading-anchor-permalink" href="#An-example-–-vortex-1" title="Permalink"></a></h2><p>To start a micromagnetic simulation, we first create a FDMesh</p><pre><code class="language-julia">mesh = FDMesh(dx=2e-9, dy=2e-9, dz=2e-9, nx=100, ny=100)</code></pre><p>After that, we create a simulation</p><pre><code class="language-julia">sim = Sim(mesh, name=&quot;vortex&quot;)</code></pre><p>and set the damping to 0.5 and switch off the precession term in LLG equation:</p><pre><code class="language-julia">sim.driver.alpha = 0.5
sim.driver.precession = false</code></pre><p>The geometry of the system can be defined by</p><pre><code class="language-julia">set_Ms(sim, circular_Ms)</code></pre><p>where <code>circular_Ms</code> could be a scalar or a function. The function should take six parameters <code>(i,j,k,dx,dy,dz)</code>, for instance</p><pre><code class="language-julia">function circular_Ms(i,j,k,dx,dy,dz)
    if (i-50.5)^2 + (j-50.5)^2 &lt;= 50^2
        return 8.6e5
    end
    return 0.0
end</code></pre><p>We add the exchange interaction and the demagnetization field to the system.</p><pre><code class="language-julia">add_exch(sim, 1.3e-11)
add_demag(sim)</code></pre><p>We need to initialise the system which can be done by defining a function</p><pre><code class="language-julia">function init_fun(i,j,k,dx,dy,dz)
  x = i-50.5
  y = j-50.5
  r = (x^2+y^2)^0.5
  if r&lt;5
    return (0,0,1)
  end
  return (y/r, -x/r, 0)
end</code></pre><p>and using</p><pre><code class="language-julia">init_m0(sim, init_fun)</code></pre><p>To trigger the simulation we relax the system</p><pre><code class="language-julia">relax(sim, maxsteps=1000)</code></pre><h2 id="How-to-enable-GPU-1"><a class="docs-heading-anchor" href="#How-to-enable-GPU-1">How to enable GPU</a><a class="docs-heading-anchor-permalink" href="#How-to-enable-GPU-1" title="Permalink"></a></h2><p>Using FDMeshGPU instead of FDMesh to switch on the GPU calculation,</p><pre><code class="language-julia">mesh = FDMeshGPU(dx=2e-9, dy=2e-9, dz=2e-9, nx=100, ny=100)</code></pre><p>The script to use GPU to obtain the vortex structure is shown below:</p><pre><code class="language-julia">using JuMag
using Printf
using NPZ

JuMag.cuda_using_double(true)
mesh =  FDMeshGPU(dx=2e-9, dy=2e-9, dz=5e-9, nx=100, ny=100, nz=4)

function circular_Ms(i,j,k,dx,dy,dz)
    x = i-50.5
    y = j-50.5
    r = (x^2+y^2)^0.5
    if (i-50.5)^2 + (j-50.5)^2 &lt;= 50^2
        return 8e5
    end
    return 0.0
end

function init_fun(i,j,k,dx,dy,dz)
  x = i-50.5
  y = j-50.5
  r = (x^2+y^2)^0.5
  if r&lt;5
    return (0,0,1)
  end
  return (y/r, -x/r, 0)
end

function relax_system()
  sim = Sim(mesh, driver=&quot;SD&quot;, name=&quot;sim&quot;)
  set_Ms(sim, circular_Ms)

  add_exch(sim, 1.3e-11, name=&quot;exch&quot;)
  add_demag(sim)

  init_m0(sim, init_fun)
  relax(sim, maxsteps=2000, stopping_torque=1.0, save_vtk_every = 100, save_m_every=-1)
  npzwrite(&quot;m0.npy&quot;, sim.spin)
end

relax_system()</code></pre><h2 id="Standard-Problem-#4-1"><a class="docs-heading-anchor" href="#Standard-Problem-#4-1">Standard Problem #4</a><a class="docs-heading-anchor-permalink" href="#Standard-Problem-#4-1" title="Permalink"></a></h2><pre><code class="language-julia">using JuMag
using Printf
using NPZ

mesh =  FDMeshGPU(nx=200, ny=50, nz=1, dx=2.5e-9, dy=2.5e-9, dz=3e-9)

function relax_system(mesh)
  sim = Sim(mesh, name=&quot;std4_relax&quot;, driver=&quot;SD&quot;)
  set_Ms(sim, 8.0e5)
  sim.driver.min_tau = 1e-10

  add_exch(sim, 1.3e-11)
  add_demag(sim)

  init_m0(sim, (1, 0.25, 0.1))

  relax(sim, maxsteps=5000, stopping_torque=10.0)
  npzwrite(&quot;m0.npy&quot;, Array(sim.spin))
end

function apply_field1(mesh)
  sim = Sim(mesh, name=&quot;std4_dyn&quot;)
  set_Ms(sim, 8.0e5)
  sim.driver.alpha = 0.02
  sim.driver.gamma = 2.211e5

  mT = 0.001 / (4*pi*1e-7)
  add_exch(sim, 1.3e-11)
  add_demag(sim)
  add_zeeman(sim, (-24.6*mT, 4.3*mT, 0))

  init_m0(sim, npzread(&quot;m0.npy&quot;))

  for i=1:100
    run_until(sim, 1e-11*i)
  end
end

relax_system(mesh)
println(&quot;Start step2 !!!&quot;)
apply_field1(mesh)
println(&quot;Run step2 again!!!&quot;)
@time apply_field1(mesh)
println(&quot;Done!&quot;)</code></pre><p>The output file is a simple text compatible with <a href="http://www.gnuplot.info/">Gnuplot</a>, like used for plot below.</p><p><img src="../scripts/std4.png" alt="std4"/></p><h2 id="A-NEB-example-(vortex-core-reversal)-1"><a class="docs-heading-anchor" href="#A-NEB-example-(vortex-core-reversal)-1">A NEB example (vortex core reversal)</a><a class="docs-heading-anchor-permalink" href="#A-NEB-example-(vortex-core-reversal)-1" title="Permalink"></a></h2><p>The magnetic vortex core can either point up or point down. In this example, we will compute the energy barrier between this two states. We will use NEB (Nudged elastic band) method.</p><p>To begin, we need to prepare this two states which can be done by defining two initial functions <code>init_m_point_up</code> and <code>init_m_point_down</code>. After running the following script, two states in the format of OVF2 (<code>up.ovf</code> and <code>down.ovf</code>) will be saved.</p><pre><code class="language-julia">using JuMag
using Printf

JuMag.cuda_using_double(true)
mesh =  FDMeshGPU(dx=2e-9, dy=2e-9, dz=5e-9, nx=100, ny=100, nz=4)

function circular_Ms(i,j,k,dx,dy,dz)
    x = i-50.5
    y = j-50.5
    r = (x^2+y^2)^0.5
    if (i-50.5)^2 + (j-50.5)^2 &lt;= 50^2
        return 8e5
    end
    return 0.0
end

function init_m_point_up(i,j,k,dx,dy,dz)
  x = i-50.5
  y = j-50.5
  r = (x^2+y^2)^0.5
  if r&lt;5
    return (0,0,1)
  end
  return (y/r, -x/r, 0)
end

function init_m_point_down(i,j,k,dx,dy,dz)
  x = i-50.5
  y = j-50.5
  r = (x^2+y^2)^0.5
  if r&lt;5
    return (0,0,1)
  end
  return (y/r, -x/r, 0)
end

function relax_system(init_fun, name)
  sim = Sim(mesh, driver=&quot;SD&quot;, name=&quot;sim&quot;)
  set_Ms(sim, circular_Ms)

  add_exch(sim, 1.3e-11, name=&quot;exch&quot;)
  add_demag(sim)

  init_m0(sim, init_fun)
  relax(sim, maxsteps=2000, stopping_torque = 1.0)
  save_ovf(sim, name)
end

for (init_m, name) in [(init_m_point_up, &quot;up&quot;), (init_m_point_down, &quot;down&quot;)]
  relax_system(init_m, name)
end</code></pre><p>After generating the two states we are interested in, we can use NEB method. In JuMag, we have a pure CPU version of NEB and a GPU version which supports multiple GPUs with the helper of MPI. In this example, we will use the latter, i.e., <code>NEB_MPI</code>. Typically, three parameters are needed to start the NEB simulation:</p><ul><li>sim – an instance of MicroSimGPU.</li><li>init<em>m – an array that contains at least two ends states. If you have more information about the middle states, you can put it into init</em>m array.</li><li>interpolations – an array to contain the number of interpolations between given states. So length(interpolations) must equal to length(init_m) - 1.</li></ul><p>So the typical usage is given as follows</p><pre><code class="language-none">function relax_neb()
    ovf1 = read_ovf(&quot;down.ovf&quot;)
    ovf2 = read_ovf(&quot;up.ovf&quot;)
    sim = create_sim()
    init_m = [ovf1.data, ovf2.data]
    interpolations = [12]
    neb = NEB_MPI(sim, init_m, interpolations, driver=&quot;LLG&quot;)
    relax(neb, maxsteps=10000, stopping_dmdt = 0.5, save_ovf_every=500)
end</code></pre><p>In the function <code>relax_neb</code> we called <code>create_sim</code> which is very similar to the function <code>relax_system</code>, actually, two functions should have exactly the same micromagnetic parameters. Here, to save GPU memory we do not use any driver (by setting <code>driver=&quot;none&quot;</code>) and let <code>save_data=false</code> when creating the Sim instance.</p><pre><code class="language-none">function create_sim()
    mesh =  FDMeshGPU(dx=2e-9, dy=2e-9, dz=5e-9, nx=100, ny=100, nz=4)
    sim = Sim(mesh, name=&quot;sim&quot;, driver=&quot;none&quot;, save_data=false)
    set_Ms(sim, circular_Ms)
    init_m0(sim, (0,0,1))
    add_demag(sim)
    add_exch(sim, 1.3e-11)
    return sim
end</code></pre><p>Moreover, if you are going to use multiple GPUs, you need to add <code>JuMag.using_multiple_gpus()</code>, the number of GPUs will be set to the number of processes of MPI. Put it all together, the script is given by</p><pre><code class="language-none">using JuMag
using CuArrays
using Printf
JuMag.cuda_using_double(true)
CuArrays.allowscalar(false)  #important for performance

JuMag.using_multiple_gpus()

function create_sim()
    mesh =  FDMeshGPU(dx=2e-9, dy=2e-9, dz=5e-9, nx=100, ny=100, nz=4)
    sim = Sim(mesh, name=&quot;sim&quot;, driver=&quot;none&quot;, save_data=false)
    set_Ms(sim, circular_Ms)
    init_m0(sim, (0,0,1))
    add_demag(sim)
    add_exch(sim, 1.3e-11)
    return sim
end

function circular_Ms(i,j,k,dx,dy,dz)
    x = i-50.5
    y = j-50.5
    r = (x^2+y^2)^0.5
    if (i-50.5)^2 + (j-50.5)^2 &lt;= 50^2
        return 8e5
    end
    return 0.0
end

function relax_neb()
    ovf1 = read_ovf(&quot;vortex_down.ovf&quot;)
    ovf2 = read_ovf(&quot;vortex_up.ovf&quot;)
    sim = create_sim()
    neb = NEB_MPI(sim,(ovf1.data, ovf2.data),(12), driver=&quot;LLG&quot;)
    relax(neb, maxsteps=10000, stopping_dmdt=1.0, save_ovf_every=500)
end

relax_neb()</code></pre><p>The Slurm script two use two GPUs:</p><pre><code class="language-none">#!/bin/bash
#SBATCH --nodes=1             # Number of nodes
#SBATCH --ntasks=2            # Number of MPI processes
#SBATCH --cpus-per-task=1     # Number of CPUs per task
#SBATCH --gres=gpu:2          # Number of GPUs
mpiexec -np 2 julia main.jl</code></pre><p><img src="../figures/neb_vortex.png" alt="neb_vortex"/></p><h2 id="Monte-Carlo-(M-T-curve)-1"><a class="docs-heading-anchor" href="#Monte-Carlo-(M-T-curve)-1">Monte Carlo (M-T curve)</a><a class="docs-heading-anchor-permalink" href="#Monte-Carlo-(M-T-curve)-1" title="Permalink"></a></h2><p>We can use Monte Carlo to compute the M-T curve. For the atomistic model with <span>$z$</span> nearest neighbors, the relation between exchange constant and <span>$T_c$</span> reads <sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup></p><div>\[J = \frac{3 k_B T_c}{ \epsilon z }\]</div><p>where <span>$\epsilon$</span> is a correction factor. For 3D classical Heisenberg model <span>$\epsilon \approx 0.719$</span>. In this example, we will assume <span>$J=300k_B$</span> which gives <span>$T_c = 431 K$</span>. The full script is shown below.</p><pre><code class="language-julia">using JuMag
using Random

JuMag.cuda_using_double(true)

function relax_system(T)
  mesh =  CubicMeshGPU(nx=30, ny=30, nz=30, pbc=&quot;xyz&quot;)
  sim = MonteCarloNew(mesh, name=&quot;mc&quot;)
  init_m0(sim, (0,0,1))

  add_exch(sim, J=300*k_B)
  add_dmi(sim, D=0, D1=0)
  add_zeeman(sim, Hx=0, Hy=0, Hz=0)
  add_anis(sim, Ku=0, Kc=0)

  sim.T = 100000
  run_sim(sim, maxsteps=50000, save_vtk_every=-1, save_m_every=-1)
  sim.T = T
  run_sim(sim, maxsteps=200000, save_vtk_every=-1, save_m_every=-1)

  ms = zeros(1000)
  sim.T = T
  for i = 1:1000
      run_sim(sim, maxsteps=100, save_vtk_every=-1, save_m_every=-1)
      t = JuMag.average_m(sim)
      ms[i] = sqrt(t[1]^2+t[2]^2+t[3]^2)
  end
  return sum(ms)/length(ms)
end

f = open(&quot;M_H.txt&quot;, &quot;w&quot;)
write(f, &quot;#T(K)     m \n&quot;)
for T = 10:20:500
    println(&quot;Running for $T ...&quot;)
    m = relax_system(T)
    write(f, &quot;$T    $m \n&quot;)
end
close(f)</code></pre><p>The obtained M-T curve is shown as follows, where the obtained <span>$T_c$</span> is closed to 440 K.s <img src="../figures/mz_T.png" alt="M_T"/></p><p><sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup> Atomistic spin model simulations of magnetic nanomaterials, J. Phys.: Condens. Matter 26 (2014) 103202.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« JuMag.jl</a><a class="docs-footer-nextpage" href="../equations/">Implemented equations »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 11 April 2020 23:58">Saturday 11 April 2020</span>. Using Julia version 1.2.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
